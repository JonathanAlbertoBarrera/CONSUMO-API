<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Alumnos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center">Gestión de Alumnos</h1>

        <!-- Formulario Registrar Alumno -->
        <div class="col-md-5 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4>Registrar Alumno</h4>
                </div>
                <div class="card-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" placeholder="Nombre completo" required>
                        </div>
                        <div class="mb-3">
                            <label for="correo" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="correo" placeholder="Correo" required>
                        </div>
                        <div class="mb-3">
                            <label for="matricula" class="form-label">Matrícula</label>
                            <input type="text" class="form-control" id="matricula" placeholder="Matrícula" required>
                        </div>
                        <div class="mb-3">
                            <label for="carrera" class="form-label">Carrera</label>
                            <input type="text" class="form-control" id="carrera" placeholder="Carrera" required>
                        </div>
                        <div class="mb-3">
                            <label for="grado_grupo" class="form-label">Grado y Grupo</label>
                            <input type="text" class="form-control" id="grado_grupo" placeholder="Ejemplo: 4 E"
                                required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Registrar</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tabla Alumnos -->
        <div class="mt-4">
            <h3 class="text-center">Lista de Alumnos</h3>
            <table class="table table-striped">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Matrícula</th>
                        <th>Carrera</th>
                        <th>Grado/Grupo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaAlumnos"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Editar Alumno -->
    <div class="modal fade" id="modalEditarAlumno" tabindex="-1" aria-labelledby="modalEditarAlumnoLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalEditarAlumnoLabel">Editar Alumno</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarAlumno">
                        <input type="hidden" id="idAlumnoEditar">
                        <div class="mb-3">
                            <label for="nombreEditar" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombreEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="correoEditar" class="form-label">Correo</label>
                            <input type="email" class="form-control" id="correoEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="matriculaEditar" class="form-label">Matrícula</label>
                            <input type="text" class="form-control" id="matriculaEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="carreraEditar" class="form-label">Carrera</label>
                            <input type="text" class="form-control" id="carreraEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="gradoGrupoEditar" class="form-label">Grado y Grupo</label>
                            <input type="text" class="form-control" id="gradoGrupoEditar" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = "http://localhost:8080/api/alumnos";

        // Registrar alumno
        document.getElementById("registerForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const alumno = {
                nombre: document.getElementById("nombre").value,
                correo: document.getElementById("correo").value,
                matricula: document.getElementById("matricula").value,
                carrera: document.getElementById("carrera").value,
                grado_grupo: document.getElementById("grado_grupo").value,
                status: true,
            };

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(alumno),
                });
                if (response.ok) {
                    alert("Alumno registrado con éxito.");
                    obtenerAlumnos();
                } else {
                    alert("Error al registrar el alumno.");
                }
            } catch (error) {
                alert("Error al conectar con el servidor.");
            }
        });

        // Obtener alumnos
        async function obtenerAlumnos() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Error al obtener alumnos.");
                const data = await response.json();
                const alumnos = data.alumnoResponse.alumno;

                const tablaAlumnos = document.getElementById("tablaAlumnos");
                tablaAlumnos.innerHTML = "";

                alumnos.forEach((alumno) => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                    <td>${alumno.id_alumno}</td>
                    <td>${alumno.nombre}</td>
                    <td>${alumno.correo}</td>
                    <td>${alumno.matricula}</td>
                    <td>${alumno.carrera}</td>
                    <td>${alumno.grado_grupo}</td>
                    <td>${alumno.status ? "Activo" : "Inactivo"}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" 
                            onclick="abrirModalEditar(${alumno.id_alumno}, '${alumno.nombre}', '${alumno.correo}', '${alumno.matricula}', '${alumno.carrera}', '${alumno.grado_grupo}')">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="cambiarEstado(${alumno.id_alumno}, ${alumno.status})">
                            ${alumno.status ? "Desactivar" : "Activar"}
                        </button>
                    </td>
                `;
                    tablaAlumnos.appendChild(fila);
                });

            } catch (error) {
                console.error("Error:", error);
            }
        }

        function abrirModalEditar(id, nombre, correo, matricula, carrera, gradoGrupo) {
            // Llenamos los campos del modal con los datos del alumno
            document.getElementById('idAlumnoEditar').value = id;
            document.getElementById('nombreEditar').value = nombre;
            document.getElementById('correoEditar').value = correo;
            document.getElementById('matriculaEditar').value = matricula;
            document.getElementById('carreraEditar').value = carrera;
            document.getElementById('gradoGrupoEditar').value = gradoGrupo;

            // Mostramos el modal
            const modal = new bootstrap.Modal(document.getElementById('modalEditarAlumno'));
            modal.show();
        }

        document.getElementById('formEditarAlumno').addEventListener('submit', async function (event) {
            event.preventDefault();

            const idAlumno = document.getElementById('idAlumnoEditar').value;
            const alumnoActualizado = {
                nombre: document.getElementById('nombreEditar').value,
                correo: document.getElementById('correoEditar').value,
                matricula: document.getElementById('matriculaEditar').value,
                carrera: document.getElementById('carreraEditar').value,
                grado_grupo: document.getElementById('gradoGrupoEditar').value
            };

            try {
                const response = await fetch(`http://localhost:8080/api/alumnos/${idAlumno}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(alumnoActualizado)
                });

                if (response.ok) {
                    alert('Alumno actualizado con éxito');
                    obtenerAlumnos(); // Refrescamos la tabla
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarAlumno'));
                    modal.hide(); // Cerramos el modal
                } else {
                    alert('Error al actualizar el alumno.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el alumno.');
            }
        });


        // Cambiar estado del alumno
        async function cambiarEstado(id, estado) {
            const nuevoEstado = !estado;
            try {
                const response = await fetch(`${apiUrl}/estatus/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: nuevoEstado }),
                });
                if (response.ok) {
                    obtenerAlumnos();
                } else {
                    alert("Error al cambiar el estado.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", obtenerAlumnos);
    </script>
</body>

</html>